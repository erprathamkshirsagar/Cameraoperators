
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>CameraOperator</title>
		<!-- Google font -->
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Font Awesome 5 (CDN) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

		<!-- Bootstrap -->
		{% load static %}
		<link type="text/css" rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}"/>
		<link type="text/css" rel="stylesheet" href="{% static 'css/slick.css' %}"/>
		<link type="text/css" rel="stylesheet" href="{% static 'css/slick-theme.css' %}"/>
		<link type="text/css" rel="stylesheet" href="{% static 'css/nouislider.min.css' %}"/>
		<link type="text/css" rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}"/>
		<link type="text/css" rel="stylesheet" href="{% static 'css/style.css' %}"/>
<style>
    

/* Card Rounded Corners */
.booking-card {
    border-radius: 22px !important;
}

/* Stylish Inputs */
.stylish-input {
    border-radius: 12px;
    padding: 12px 15px;
    border: 2px solid #e9e9e9;
    transition: 0.3s;
}

.stylish-input:focus {
    border-color: #dc3545;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.4);
}

/* Detail Row */
.detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
    font-weight: 600;
}



/* Total Days */
.value-text {
    font-size: 1.2rem;
    font-weight: bold;
}

/* Total Amount */
.value-total {
    font-size: 1.3rem;
    color: #28a745;
    font-weight: bold;
}

/* Stylish button */
.stylish-btn {
    border-radius: 14px;
    padding: 12px 0;
    font-size: 1.2rem;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.35);
    transition: 0.3s ease;
}


/* Booked dates: red background */
.flatpickr-day.booked {
  background-color: #ffcccc !important;
  color: #b30000 !important;
}

/* Available dates: green background */
.flatpickr-day.available {
  background-color: #d4edda !important;
  color: #155724 !important;
}

/* Disabled dates (like past dates) will be grayed by flatpickr automatically */

</style>

    </head>
	<body>
		<!-- HEADER -->
<header>
    <!-- MAIN HEADER -->
    <div id="header">
        <div class="container">
            <div class="row align-items-center">
                
                <!-- LOGO -->
                <div class="col-md-3">
                    <div class="header-logo">
                        <a href="{% url 'dashboard' %}" class="logo">
                            <img src="{% static 'img/logo.png' %}" alt="Logo">
                        </a>
                    </div>
                </div>
                <!-- /LOGO -->

                <!-- SEARCH BAR -->
                <div class="col-md-6">
                    <div class="header-search">
                        <form method="get" action="{% url 'dashboard' %}">
                            <select class="input-select" name="category">
                                <option value="0">All Categories</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <input class="input" type="text" name="q" placeholder="Search here">
                            <button class="search-btn btn btn-primary" type="submit">Search</button>
                        </form>
                    </div>
                </div>
                <!-- /SEARCH BAR -->

                <!-- ACCOUNT -->
<div class="col-md-3 text-end">
    <div class="header-ctn d-flex justify-content-end align-items-center">

        {% if request.session.user_id %}
            <!-- Messages (only if logged in) -->
            <div class="me-3 position-relative">
                <a href="{% url 'chat' %}">
                    <i class="fa fa-envelope-o"></i>
                    <span>Messages</span>
                    <div class="qty position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        2
                    </div>
                </a>
            </div>


<!-- Profile Dropdown -->
<div class="dropdown">
    <a class="dropdown-toggle text-decoration-none d-flex align-items-center" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa fa-user-o me-2"></i>
        <span>My Profile</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown" style="min-width: 200px;">

        <!-- Welcome Section -->
        <li class="px-3 py-2 text-start">
    <div class="small text-muted">Welcome,</div>
<div class="fw-bold">
    {{ user_name }}
    {% if profile_status == 'verified' %}
        <img src="{% static 'img/verified.png' %}" alt="Verified" class="ms-2" style="width:18px; height:18px;">
    {% endif %}
</div>

</li>

        <li><hr class="dropdown-divider my-1"></li>

        <!-- Profile -->
        <li>
            <a class="dropdown-item d-flex align-items-center py-1" href="{% url 'profile' %}">
                <i class="fa fa-id-badge me-2"></i> Profile
            </a>
        </li>
		 <!-- Document Verification -->
        <!-- Document Verification -->
{% if profile_status != 'verified' %}
<li>
    <a class="dropdown-item d-flex align-items-center py-1" href="{% url 'documentverification' %}">
        <i class="fa fa-users me-2"></i> Document Verification
    </a>
</li>
{% endif %}


        <!-- Freelancer -->
        <li>
            <a class="dropdown-item d-flex align-items-center py-1" href="{% url 'freelancer' %}">
                <i class="fa fa-users me-2"></i> Freelancer
            </a>
        </li>

        <!-- Booking -->
        <li>
            <a class="dropdown-item d-flex align-items-center py-1" href="{% url 'dashboard' %}">
<i class="fas fa-calendar me-2"></i> Booking
            </a>
        </li>

        <!-- Product -->
        <li>
            <a class="dropdown-item d-flex align-items-center py-1" href="{% url 'dashboard' %}">
        <i class="fas fa-box-open me-2"></i> Product
            </a>
        </li>

        <li><hr class="dropdown-divider my-1"></li>

        <!-- Logout -->
        <li>
            <a class="dropdown-item d-flex align-items-center py-1 text-danger" href="{% url 'logout' %}">
        <i class="fas fa-sign-out-alt me-2"></i> Logout
            </a>
        </li>

    </ul>
</div>


        {% else %}
            <!-- Login Link -->
            <div>
                <a class="text-decoration-none" href="{% url 'login' %}">
                    <i class="fa fa-user-o"></i> Login
                </a>
            </div>
        {% endif %}

        <!-- Menu Toggle for mobile -->
        <div class="menu-toggle ms-3 d-lg-none">
            <a href="#" class="text-decoration-none">
                <i class="fa fa-bars"></i>
                <span>Menu</span>
            </a>
        </div>

    </div>
</div>
<!-- /ACCOUNT -->


            </div>
        </div>
    </div>
    <!-- /MAIN HEADER -->
</header>
<!-- /HEADER -->
 <!-- NAVIGATION -->
<nav id="navigation">
    <div class="container">
        <div id="responsive-nav">
            <ul class="main-nav nav navbar-nav">
                <li class="active"><a href="{% url 'dashboard' %}">Home</a></li>
                <!-- Loop through categories -->
                {% for cat in categories %}
                    <li><a href="#">{{ cat.name }}</a></li>
                {% endfor %}
                
            </ul>
        </div>
    </div>
</nav>
<!-- /NAVIGATION -->
<br>

<br>
{% load humanize %}

<div class="container my-5">
  <div class="row justify-content-center gx-5">

    <!-- Left: Product Images -->
    <div class="col-md-5 mb-4">
  <div class="mb-3">

    {% if images and images.0.image %}
      <!-- MAIN IMAGE -->
      <img src="{{ images.0.image.url }}"
           alt="{{ product.title }}"
           id="mainImage"
           class="img-fluid rounded shadow-sm"
           style="width: 100%; height: auto; object-fit: contain;">

    {% else %}
      <!-- PLACEHOLDER WHEN NO IMAGE -->
      <img src="https://via.placeholder.com/500x400?text=No+Image+Available"
           alt="No Image"
           id="mainImage"
           class="img-fluid rounded shadow-sm"
           style="width: 100%; height: auto; object-fit: contain;">
    {% endif %}

  </div>

  <!-- THUMBNAILS -->
  <div class="d-flex gap-2 flex-wrap">

    {% if images %}
      {% for img in images %}
        <img src="{{ img.image.url }}"
             alt="{{ product.title }}"
             class="img-thumbnail"
             style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
             onclick="document.getElementById('mainImage').src='{{ img.image.url }}'">
      {% endfor %}
    {% else %}
      <!-- PLACEHOLDER THUMBNAIL -->
      <img src="https://via.placeholder.com/80x80?text=No+Image"
           class="img-thumbnail"
           style="width: 80px; height: 80px; object-fit: cover;">
    {% endif %}

  </div>
</div>


    <!-- Right: Product Details + Booking -->
    <div class="col-md-7">
      <h2 class="fw-bold">{{ product.title }}</h2>
      <p class="text-muted mb-1"><strong>Type:</strong> {{ product.get_type_display }}</p>

      {% if product.type == 'sell' %}
        <h4 class="text-success">₹{{ product.price|intcomma }}</h4>
      {% elif product.type == 'rent' %}
        <h4 class="text-primary">₹{{ product.rent_per_day|intcomma }} / day</h4>
      {% endif %}

      <hr>

      <h5>Description</h5>
      <p>{{ product.description|linebreaksbr }}</p>

      <hr>
<!-- Booking Form Card -->
<div class="card booking-card shadow-lg border-0 rounded-4">
  
  <!-- HEADER -->
  <div class="card-header bg-gradient-danger text-white rounded-top-4 py-3">
    <h4 class="mb-0 fw-bold">
      <i class="fas fa-calendar-check me-2"></i>Book This Product
    </h4>
  </div>

  <!-- BODY -->
  <div class="card-body p-4">

    <form method="post" action="{% url 'book_product' product.id %}">
      {% csrf_token %}

      <!-- Start Date -->
      <div class="mb-4">
        <label for="start_date" class="form-label fw-semibold">
          <i class="fas fa-play-circle me-1 text-danger"></i> Start Date
        </label>
        <input type="date"
               id="start_date"
               name="start_date"
               class="form-control form-control-lg stylish-input"
               required min="{{ today }}">
      </div>

      <!-- End Date -->
      <div class="mb-4">
        <label for="end_date" class="form-label fw-semibold">
          <i class="fas fa-stop-circle me-1 text-danger"></i> End Date
        </label>
        <input type="date"
               id="end_date"
               name="end_date"
               class="form-control form-control-lg stylish-input"
               required min="{{ today }}">
      </div>

      <!-- Price Per Day -->
      <div class="detail-row mb-3">
        <span>Price per Day:</span>
        <span class="value-badge">₹{{ product.rent_per_day }}</span>
      </div>

      <!-- Total Days -->
      <div class="detail-row mb-3">
        <span>Total Days:</span>
        <span id="total_days" class="value-text">0</span>
      </div>

      <!-- Total Amount -->
      <div class="detail-row mb-4">
        <span>Total Amount:</span>
        <span id="total_amount" class="value-total">₹0</span>
      </div>

      <!-- BOOK NOW BTN -->
      <button type="submit" class="btn btn-danger btn-lg w-100 fw-bold stylish-btn">
        <i class="fas fa-shopping-cart me-2"></i> Book Now 
      </button>
      {% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
  {% endfor %}
{% endif %}

    </form>

  </div>

  <!-- FOOTER -->
  <div class="card-footer bg-light text-center rounded-bottom-4 py-3">
    <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-secondary rounded-pill px-4">
      &laquo; Back to product details
    </a>
  </div>

</div>

</div>

  </div>
</div>


<br>
		<!-- FOOTER -->
		<footer id="footer">
			<!-- top footer -->
			<div class="section">
				<!-- container -->
				<div class="container">
					<!-- row -->
					<div class="row">
						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">About Us</h3>
								<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut.</p>
								<ul class="footer-links">
									<li><a href="#"><i class="fa fa-map-marker"></i>1734 Stonecoal Road</a></li>
									<li><a href="#"><i class="fa fa-phone"></i>+021-95-51-84</a></li>
									<li><a href="#"><i class="fa fa-envelope-o"></i>email@email.com</a></li>
								</ul>
							</div>
						</div>

						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">Categories</h3>
								<ul class="footer-links">
									<li><a href="#">Hot deals</a></li>
									<li><a href="#">Laptops</a></li>
									<li><a href="#">Smartphones</a></li>
									<li><a href="#">Cameras</a></li>
									<li><a href="#">Accessories</a></li>
								</ul>
							</div>
						</div>

						<div class="clearfix visible-xs"></div>

						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">Information</h3>
								<ul class="footer-links">
									<li><a href="#">About Us</a></li>
									<li><a href="#">Contact Us</a></li>
									<li><a href="#">Privacy Policy</a></li>
									<li><a href="#">Orders and Returns</a></li>
									<li><a href="#">Terms & Conditions</a></li>
								</ul>
							</div>
						</div>

						<div class="col-md-3 col-xs-6">
							<div class="footer">
								<h3 class="footer-title">Service</h3>
								<ul class="footer-links">
									<li><a href="#">My Account</a></li>
									<li><a href="#">View Cart</a></li>
									<li><a href="#">Wishlist</a></li>
									<li><a href="#">Track My Order</a></li>
									<li><a href="#">Help</a></li>
								</ul>
							</div>
						</div>
					</div>
					<!-- /row -->
				</div>
				<!-- /container -->
			</div>
			<!-- /top footer -->

			<!-- bottom footer -->
			<div id="bottom-footer" class="section">
				<div class="container">
					<!-- row -->
					<div class="row">
						<div class="col-md-12 text-center">
							<ul class="footer-payments">
								<li><a href="#"><i class="fa fa-cc-visa"></i></a></li>
								<li><a href="#"><i class="fa fa-credit-card"></i></a></li>
								<li><a href="#"><i class="fa fa-cc-paypal"></i></a></li>
								<li><a href="#"><i class="fa fa-cc-mastercard"></i></a></li>
								<li><a href="#"><i class="fa fa-cc-discover"></i></a></li>
								<li><a href="#"><i class="fa fa-cc-amex"></i></a></li>
							</ul>
							<span class="copyright">
								<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
								Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved</a>
							<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
							</span>
						</div>
					</div>
						<!-- /row -->
				</div>
				<!-- /container -->
			</div>
			<!-- /bottom footer -->
		</footer>
		<!-- /FOOTER -->
    <script>
  // Prepare booked ranges in format Flatpickr understands for disable
  const bookedRanges = [
    {% for booking in booked_dates %}
      {
        from: "{{ booking.start_date }}",
        to: "{{ booking.end_date }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Create a Set of all booked individual dates (to color red)
  const bookedDatesSet = new Set();
  bookedRanges.forEach(range => {
    let currentDate = new Date(range.from);
    const endDate = new Date(range.to);
    while (currentDate <= endDate) {
      bookedDatesSet.add(currentDate.toDateString());
      currentDate.setDate(currentDate.getDate() + 1);
    }
  });

  // Helper function to check if a date is in the past relative to today
  function isPastDate(date) {
    const today = new Date("{{ today }}");
    // Clear time portion for accurate comparison
    today.setHours(0, 0, 0, 0);
    date.setHours(0, 0, 0, 0);
    return date < today;
  }

  // Initialize start date picker
  const startPicker = flatpickr("#start_date", {
    minDate: "{{ today }}",        // Disable past dates selection
    disable: bookedRanges,         // Disable booked ranges
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      const dateObj = dayElem.dateObj;
      const dateStr = dateObj.toDateString();

      if (bookedDatesSet.has(dateStr)) {
        dayElem.classList.add('booked');  // Mark booked dates red
      } else if (!isPastDate(dateObj)) {
        dayElem.classList.add('available');  // Mark available future dates green
      }
      // Past dates get no special class but are disabled by minDate
    },
    onChange: function(selectedDates, dateStr, instance) {
      if (selectedDates.length > 0) {
        endPicker.set('minDate', dateStr);  // End date can't be before start date
        calculateDaysAndAmount();
      }
    }
  });

  // Initialize end date picker
  const endPicker = flatpickr("#end_date", {
    minDate: "{{ today }}",
    disable: bookedRanges,
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      const dateObj = dayElem.dateObj;
      const dateStr = dateObj.toDateString();

      if (bookedDatesSet.has(dateStr)) {
        dayElem.classList.add('booked');
      } else if (!isPastDate(dateObj)) {
        dayElem.classList.add('available');
      }
    },
    onChange: function(selectedDates, dateStr, instance) {
      calculateDaysAndAmount();
    }
  });

  // Calculate total days and amount based on selected dates
  const totalDaysSpan = document.getElementById('total_days');
  const totalAmountSpan = document.getElementById('total_amount');
  const pricePerDay = {{ product.rent_per_day|default:0 }};

  function calculateDaysAndAmount() {
    const startDateVal = document.getElementById('start_date').value;
    const endDateVal = document.getElementById('end_date').value;

    if (startDateVal && endDateVal) {
      const startDate = new Date(startDateVal);
      const endDate = new Date(endDateVal);

      if (endDate >= startDate) {
        const diffTime = endDate - startDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // inclusive
        totalDaysSpan.textContent = diffDays;
        totalAmountSpan.textContent = '₹' + (diffDays * pricePerDay);
        return;
      }
    }
    totalDaysSpan.textContent = 0;
    totalAmountSpan.textContent = '₹0';
  }
</script>


		<script src="{% static 'js/jquery.min.js' %}"></script>
		<script src="{% static 'js/bootstrap.min.js' %}"></script>
		<script src="{% static 'js/slick.min.js' %}"></script>
		<script src="{% static 'js/nouislider.min.js' %}"></script>
		<script src="{% static 'js/jquery.zoom.min.js' %}"></script>
		<script src="{% static 'js/main.js' %}"></script>
	</body>
</html>
